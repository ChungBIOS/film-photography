<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fontana ‚Äî Chi Yuen Chung</title>
  <meta name="description" content="Fontana Event Photos" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="icon" href="/favicon.ico">
  <meta property="og:title" content="Fontana ‚Äî Chi Yuen Chung">
  <meta property="og:description" content="Fontana Event Photos">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://chiyuenchung.com/fontana/">
  <link rel="stylesheet" href="../css/styles.css?v=7">
</head>
<body>
  <header>
    <a class="brand" href="/"><h1>Chi Yuen Chung</h1></a>
    <p>Fontana Event</p>
  </header>

  <!-- Filter banner appears only when a facet is active -->
  <div id="tag-filter-bar" class="tag-filter" hidden></div>

  <main class="grid" id="gallery" aria-live="polite"></main>

  <footer>
    <p>¬© 2025 Chi Yuen Chung</p>
  </footer>

  <script>
    let galleryPhotos = [];
    let currentIndex = -1;

    // ---------- helpers ----------
    const norm = s => (s || "").toString().trim().toLowerCase();
    const getAll = (search, key) =>
      (search.get(key) || "")
        .split(",")
        .map(s => s.trim())
        .filter(Boolean)
        .map(norm);

    const uniq = arr => [...new Set(arr)];

    function buildURL(state){
      const qs = new URLSearchParams();
      if (state.tags?.length)   qs.set("tags",   uniq(state.tags).join(","));
      if (state.camera?.length) qs.set("camera", uniq(state.camera).join(","));
      if (state.lens?.length)   qs.set("lens",   uniq(state.lens).join(","));
      if (state.film?.length)   qs.set("film",   uniq(state.film).join(","));
      const s = qs.toString();
      // Relative URL for subfolder
      return s ? "?" + s : "./";
    }
    function addFacet(state, facet, value){
      const next = JSON.parse(JSON.stringify(state));
      const v = norm(value);
      next[facet] = uniq([...(next[facet] || []), v]);
      return next;
    }
    function removeFacet(state, facet, value){
      const next = JSON.parse(JSON.stringify(state));
      const v = norm(value);
      next[facet] = (next[facet] || []).filter(x => x !== v);
      return next;
    }
    function readState(){
      const params = new URLSearchParams(location.search);
      return {
        tags:   getAll(params, "tags"),
        camera: getAll(params, "camera"),
        lens:   getAll(params, "lens"),
        film:   getAll(params, "film"),
      };
    }

    // ---------- render ----------
    async function renderGallery(){
      const el = document.getElementById("gallery");
      const tagBar = document.getElementById("tag-filter-bar");
      const state = readState();

      try{
        const res = await fetch("/img/photos.json?v=" + Date.now());
        const incoming = await res.json();

        // normalize tags
        const photos = incoming.map(p => {
          let tags = [];
          if (Array.isArray(p.tags)) tags = p.tags;
          else if (p.tags) tags = String(p.tags).split(",").map(t => t.trim()).filter(Boolean);
          return { ...p, tags };
        });

        // newest-first
        photos.sort((a,b) => new Date(b.ts || b.date || 0) - new Date(a.ts || a.date || 0));

        // AND filter across all selected facets + HARDCODE "fontana"
        const filtered = photos.filter(p => {
          const pTags   = (p.tags || []).map(norm);
          
          // HARD REQUIREMENT: Must have "fontana" tag
          if (!pTags.includes("fontana")) return false;

          const pCamera = norm(p.camera);
          const pLens   = norm(p.lens);
          const pFilm   = norm(p.film);
          if (state.tags.length   && !state.tags.every(t => pTags.includes(t))) return false;
          if (state.camera.length && !state.camera.includes(pCamera)) return false;
          if (state.lens.length   && !state.lens.includes(pLens))     return false;
          if (state.film.length   && !state.film.includes(pFilm))     return false;
          return true;
        });

        galleryPhotos = filtered;

        // banner chips (removable)
        // Note: we don't show "fontana" as a removable chip because it's inherent to the page
        const visibleTags = (state.tags || []).filter(t => t !== "fontana");
        
        const chips = []
          .concat(visibleTags.map(v => ({facet:"tags",   label:"#"+v,  v})))
          .concat((state.camera || []).map(v => ({facet:"camera", label:"üì∑ "+v, v})))
          .concat((state.lens   || []).map(v => ({facet:"lens",   label:"üî≠ "+v, v})))
          .concat((state.film   || []).map(v => ({facet:"film",   label:"üéûÔ∏è "+v, v})));

        if (chips.length){
          tagBar.hidden = false;
          tagBar.innerHTML = `
            <div class="tag-filter-inner">
              <span>Filters:</span>
              ${chips.map(c => `
                <span class="tag-pill tag-pill--solid">
                  ${c.label}
                  <a class="tag-clear" href="${buildURL(removeFacet(state, c.facet, c.v))}" aria-label="Remove ${c.label}">√ó</a>
                </span>
              `).join("")}
              <a class="tag-clear" href="./" aria-label="Clear all filters">Clear all</a>
            </div>
          `;
          document.title = `Filters ‚Äî Fontana ‚Äî Chi Yuen Chung`;
        } else {
          tagBar.hidden = true;
          document.title = "Fontana ‚Äî Chi Yuen Chung";
        }

        // cards
        const html = filtered.map((p, idx) => {
          const base   = p.base;
          const title  = p.title || base;
          const alt    = (p.alt || title || base).replace(/"/g, "&quot;");
          const camera = p.camera || "";
          const lens   = p.lens   || "";
          const film   = p.film   || "";
          const place  = p.location || "";
          const shot   = p.taken || "";
          const commit = p.date  || "";

          // tag pills (click to add tags)
          const tagPills = (p.tags && p.tags.length)
            ? `<ul class="tags">` + p.tags.map(t => {
                if(t.toLowerCase() === 'fontana') return ""; // Don't verify fontana tag as a filter we can add/remove, since it's the base
                const href = buildURL(addFacet(state, "tags", t));
                return `<li><a class="tag-pill" href="${href}">#${t}</a></li>`;
              }).join("") + `</ul>`
            : "";

          // meta with inline facet links
          const metaList = (camera || lens || film || place) ? `
            <ul class="meta meta--stack">
              ${camera ? `<li class="meta-item">üì∑ <a class="meta-link" href="${buildURL(addFacet(state, 'camera', camera))}">${camera}</a></li>` : ""}
              ${lens   ? `<li class="meta-item">üî≠ <a class="meta-link" href="${buildURL(addFacet(state, 'lens', lens))}">${lens}</a></li>`     : ""}
              ${film   ? `<li class="meta-item">üéûÔ∏è <a class="meta-link" href="${buildURL(addFacet(state, 'film', film))}">${film}</a></li>`     : ""}
              ${place  ? `<li class="meta-item">üìç ${place}</li>` : ""}
            </ul>` : "";

          return `
            <article class="card" data-index="${idx}">
              <a class="tile-link" href="/img/${base}-2560.jpg" data-index="${idx}" aria-label="Open full-size image of ${alt}">
                <div class="square">
                  <img
                    src="/img/${base}-640.jpg"
                    srcset="/img/${base}-640.jpg 640w,
                            /img/${base}-1280.jpg 1280w,
                            /img/${base}-2560.jpg 2560w"
                    sizes="(max-width: 900px) 90vw, 480px"
                    alt="${alt}" loading="lazy" />
                  ${p.overlay ? `<div class="tile-overlay">${p.overlay}</div>` : ""}
                </div>
              </a>

              <span class="museum-label">
                <span class="caption">
                  <span class="caption-title">${title}</span>
                  ${shot ? `<time class="date-badge" datetime="${shot}">${shot}</time>`
                         : (commit ? `<time class="date-badge" datetime="${commit}">${commit}</time>` : "")}
                </span>
                <span class="museum-rule" aria-hidden="true"></span>
                ${metaList}
                ${tagPills}
              </span>
            </article>
          `;
        }).join("");  /* <-- close map + join */

        el.innerHTML = html || '<p class="center">No Fontana photos found.</p>';
      } catch(err){
        console.error("Failed to load photos.json", err);
        document.getElementById("gallery").innerHTML = '<p class="center">Loading photos‚Ä¶</p>';
      }
    }

    renderGallery();

    // ---------- Lightbox (only images; meta/tag links won‚Äôt trigger) ----------
    document.addEventListener('click', (e) => {
      const a = e.target.closest('.tile-link');
      if (!a) return;
      e.preventDefault();
      currentIndex = parseInt(a.dataset.index, 10);
      openLightbox(currentIndex);
    });

    function openLightbox(index){
      const photo = galleryPhotos[index];
      if (!photo) return;

      const overlay = document.createElement('div');
      overlay.className = 'lightbox-overlay';
      overlay.setAttribute('role','dialog');
      overlay.setAttribute('aria-modal','true');
      overlay.tabIndex = -1;
      overlay.style = `
        position:fixed;inset:0;background:rgba(0,0,0,.92);
        display:flex;align-items:center;justify-content:center;z-index:9999;
      `;

      const closeBtn = document.createElement('div');
      closeBtn.className = 'lb-close';
      closeBtn.textContent = '√ó';

      const img = new Image();
      img.src = `/img/${photo.base}-2560.jpg`;
      img.alt = '';
      img.style = 'max-width:95vw;max-height:95vh;';

      const prevBtn = document.createElement('button');
      prevBtn.className = 'lb-arrow lb-prev';
      prevBtn.setAttribute('aria-label', 'Previous photo');
      prevBtn.innerHTML = '&#10094;';

      const nextBtn = document.createElement('button');
      nextBtn.className = 'lb-arrow lb-next';
      nextBtn.setAttribute('aria-label', 'Next photo');
      nextBtn.innerHTML = '&#10095;';

      overlay.appendChild(closeBtn);
      overlay.appendChild(prevBtn);
      overlay.appendChild(nextBtn);
      overlay.appendChild(img);
      document.body.appendChild(overlay);
      document.body.style.overflow = 'hidden';

      const close = () => {
        overlay.remove();
        document.removeEventListener('keydown', keyHandler);
        document.body.style.overflow = '';
      };
      const step = delta => {
        currentIndex = (currentIndex + delta + galleryPhotos.length) % galleryPhotos.length;
        const p = galleryPhotos[currentIndex];
        img.src = `/img/${p.base}-2560.jpg`;
      };
      const keyHandler = ev => {
        if (ev.key === 'Escape') close();
        if (ev.key === 'ArrowRight') step(1);
        if (ev.key === 'ArrowLeft') step(-1);
      };

      closeBtn.addEventListener('click', close);
      overlay.addEventListener('click', ev => { if (ev.target === overlay) close(); });
      prevBtn.addEventListener('click', () => step(-1));
      nextBtn.addEventListener('click', () => step(1));
      document.addEventListener('keydown', keyHandler);

      overlay.focus();
    }
  </script>
</body>
</html>
