<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chi Yuen Chung</title>
  <meta name="description" content="35mm and medium-format" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="icon" href="/favicon.ico">
  <meta property="og:title" content="Chi Yuen Chung">
  <meta property="og:description" content="35mm and medium-format">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://chiyuenchung.com/">
  <link rel="stylesheet" href="./css/styles.css?v=5">
</head>
<body>
  <header>
    <a class="brand" href="/"><h1>Chi Yuen Chung</h1></a>
    <p>35mm and medium-format</p>
  </header>

  <main class="grid" id="gallery" aria-live="polite"></main>

  <footer>
    <p>¬© 2025 Chi Yuen Chung</p>
  </footer>

  <script>
    let galleryPhotos = [];
    let currentIndex = -1;

    async function renderGallery() {
      const el = document.getElementById('gallery');
      try {
        const res = await fetch('/img/photos.json?v=' + Date.now());
        const photos = await res.json();

        // newest-first by timestamp
        photos.sort((a, b) => new Date(b.ts || b.date || 0) - new Date(a.ts || a.date || 0));
        galleryPhotos = photos;

        const html = photos.map((p, idx) => {
          const base = p.base;
          const title = p.title || base;
          const alt = (p.alt || title || base).replace(/"/g, '&quot;');

          // CSV-sourced metadata
          const camera = p.camera || '';
          const lens   = p.lens   || '';
          const film   = p.film   || '';
          const place  = p.location || '';
          const shot   = p.date_taken || '';   // from sheet
          const commit = p.date || '';         // fallback from commit

          return `
            <a class="card" href="/img/${base}-2560.jpg" data-index="${idx}" aria-label="Open full-size image of ${alt}">
              <div class="square">
                <img
                  src="/img/${base}-640.jpg"
                  srcset="/img/${base}-640.jpg 640w,
                          /img/${base}-1280.jpg 1280w,
                          /img/${base}-2560.jpg 2560w"
                  sizes="(max-width: 900px) 90vw, 480px"
                  alt="${alt}" loading="lazy" />
                ${p.overlay ? `<div class="tile-overlay">${p.overlay}</div>` : ''}
              </div>

              <span class="caption">
                <span class="caption-title">${title}</span>
                ${shot ? `<time class="date-badge" datetime="${shot}">${shot}</time>` :
                         (commit ? `<time class="date-badge" datetime="${commit}">${commit}</time>` : '')}
              </span>

              ${(camera || lens || film || place) ? `
                <ul class="meta">
                  ${camera ? `<li class="meta-item" title="Camera">üì∑ ${camera}</li>` : ''}
                  ${lens   ? `<li class="meta-item" title="Lens">üî≠ ${lens}</li>` : ''}
                  ${film   ? `<li class="meta-item" title="Film">üéûÔ∏è ${film}</li>` : ''}
                  ${place  ? `<li class="meta-item" title="Location">üìç ${place}</li>` : ''}
                </ul>
              ` : ''}
            </a>
          `;
        }).join('');

        el.innerHTML = html || '<p class="center">No photos yet.</p>';
      } catch (e) {
        console.error('Failed to load photos.json', e);
        el.innerHTML = '<p class="center">Loading photos‚Ä¶</p>';
      }
    }
    renderGallery();

    // Lightbox
    document.addEventListener('click', e => {
      const a = e.target.closest('a.card');
      if (!a) return;
      e.preventDefault();
      currentIndex = parseInt(a.dataset.index, 10);
      openLightbox(currentIndex);
    });

    function openLightbox(index) {
      const photo = galleryPhotos[index];
      if (!photo) return;

      const overlay = document.createElement('div');
      overlay.className = 'lightbox-overlay';
      overlay.setAttribute('role','dialog');
      overlay.setAttribute('aria-modal','true');
      overlay.tabIndex = -1;
      overlay.style = `
        position:fixed;inset:0;background:rgba(0,0,0,.92);
        display:flex;align-items:center;justify-content:center;z-index:9999;
      `;

      const closeBtn = document.createElement('div');
      closeBtn.className = 'lb-close';
      closeBtn.textContent = '√ó';

      const img = new Image();
      img.src = `/img/${photo.base}-2560.jpg`;
      img.alt = '';
      img.style = 'max-width:95vw;max-height:95vh;';

      // arrows
      const prevBtn = document.createElement('button');
      prevBtn.className = 'lb-arrow lb-prev';
      prevBtn.setAttribute('aria-label', 'Previous photo');
      prevBtn.innerHTML = '&#10094;';

      const nextBtn = document.createElement('button');
      nextBtn.className = 'lb-arrow lb-next';
      nextBtn.setAttribute('aria-label', 'Next photo');
      nextBtn.innerHTML = '&#10095;';

      overlay.appendChild(closeBtn);
      overlay.appendChild(prevBtn);
      overlay.appendChild(nextBtn);
      overlay.appendChild(img);
      document.body.appendChild(overlay);
      document.body.style.overflow = 'hidden';

      const close = () => {
        overlay.remove();
        document.removeEventListener('keydown', keyHandler);
        document.body.style.overflow = '';
      };
      const step = delta => {
        currentIndex = (currentIndex + delta + galleryPhotos.length) % galleryPhotos.length;
        const p = galleryPhotos[currentIndex];
        img.src = `/img/${p.base}-2560.jpg`;
      };
      const keyHandler = ev => {
        if (ev.key === 'Escape') close();
        if (ev.key === 'ArrowRight') step(1);
        if (ev.key === 'ArrowLeft') step(-1);
      };

      closeBtn.addEventListener('click', close);
      overlay.addEventListener('click', ev => { if (ev.target === overlay) close(); });
      prevBtn.addEventListener('click', () => step(-1));
      nextBtn.addEventListener('click', () => step(1));
      document.addEventListener('keydown', keyHandler);

      overlay.focus();
    }
  </script>
</body>
</html>
