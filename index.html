<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chi Yuen Chung</title>
  <meta name="description" content="35mm and medium-format" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="icon" href="/favicon.ico">
  <meta property="og:title" content="Chi Yuen Chung">
  <meta property="og:description" content="35mm and medium-format">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://chiyuenchung.com/">
  <link rel="stylesheet" href="./css/styles.css?v=7">
</head>
<body>
  <header>
    <a class="brand" href="/"><h1>Chi Yuen Chung</h1></a>
    <p>35mm and medium-format</p>
  </header>

  <!-- tag filter banner (only shown when ?tag=...) -->
  <div id="tag-filter-bar" class="tag-filter" hidden></div>

  <main class="grid" id="gallery" aria-live="polite"></main>

  <footer>
    <p>Â© 2025 Chi Yuen Chung</p>
  </footer>
<script>
  let galleryPhotos = [];
  let currentIndex = -1;

  // helpers
  const getParam = (name) => new URLSearchParams(location.search).get(name);
  const norm = s => (s || "").toString().trim().toLowerCase();

  // Tag URL helpers (multi-select)
  function buildTagUrl(tags) {
    if (!tags.length) return '/';
    return '/?tags=' + encodeURIComponent(tags.join(','));
  }
  function addTag(arr, tag) {
    return arr.includes(tag) ? arr : [...arr, tag];
  }
  function removeTag(arr, tag) {
    return arr.filter(t => t !== tag);
  }

  // Render
  async function renderGallery() {
    const el = document.getElementById('gallery');
    const tagBar = document.getElementById('tag-filter-bar');

    // multiple tags param (AND mode)
    const activeTagsRaw = getParam('tags');
    const activeTags = activeTagsRaw
      ? activeTagsRaw.split(',').map(t => norm(t)).filter(Boolean)
      : [];

    try {
      const res = await fetch('/img/photos.json?v=' + Date.now());
      const incoming = await res.json();

      // normalize tags + build searchable token set (tags + camera/lens/film tokens)
      const photos = incoming.map(p => {
        let tags = [];
        if (Array.isArray(p.tags)) tags = p.tags;
        else if (p.tags) tags = String(p.tags).split(',').map(t => t.trim()).filter(Boolean);

        // facet tokens
        const facetTokens = [];
        if (p.camera) facetTokens.push(`camera:${p.camera}`);
        if (p.lens)   facetTokens.push(`lens:${p.lens}`);
        if (p.film)   facetTokens.push(`film:${p.film}`);

        // everything we can filter on:
        const searchTokens = [
          ...tags,
          ...facetTokens
        ].map(norm);

        return { ...p, tags, facetTokens, searchTokens };
      });

      // newest-first by commit timestamp/date
      photos.sort((a, b) => new Date(b.ts || b.date || 0) - new Date(a.ts || a.date || 0));

      // filter by AND of activeTags
      const filtered = activeTags.length
        ? photos.filter(p => activeTags.every(tag => p.searchTokens.includes(tag)))
        : photos;

      galleryPhotos = filtered;

      // Top banner with nice labels for active filters
      if (activeTags.length) {
        tagBar.hidden = false;

        const pillHTML = activeTags.map(t => {
          // pretty label for facet tokens
          let label = `#${t}`;
          if (t.startsWith('camera:')) label = `ğŸ“· ${t.slice(7)}`;
          else if (t.startsWith('lens:')) label = `ğŸ”­ ${t.slice(5)}`;
          else if (t.startsWith('film:')) label = `ğŸï¸ ${t.slice(5)}`;

          return `
            <span class="tag-pill tag-pill--solid">
              ${label}
              <a href="${buildTagUrl(removeTag(activeTags, t))}" class="tag-clear" aria-label="Remove filter">Ã—</a>
            </span>
          `;
        }).join('');

        tagBar.innerHTML = `
          <div class="tag-filter-inner">
            <span>Filters:</span>
            ${pillHTML}
            <a class="tag-clear" href="/">Clear all</a>
          </div>
        `;

        document.title = `${activeTags.join(' Â· ')} â€” Chi Yuen Chung`;
      } else {
        tagBar.hidden = true;
        document.title = 'Chi Yuen Chung';
      }

      // Cards
      const html = filtered.map((p, idx) => {
        const base   = p.base;
        const title  = p.title || base;
        const alt    = (p.alt || title || base).replace(/"/g, '&quot;');
        const camera = p.camera || '';
        const lens   = p.lens   || '';
        const film   = p.film   || '';
        const place  = p.location || '';
        const shot   = p.taken || '';  // preferred (sheet)
        const commit = p.date  || '';  // fallback (commit)

        // regular tag pills -> clicking adds tag
        const tagPills = (p.tags && p.tags.length)
          ? `<ul class="tags">` +
              p.tags.map(t => {
                const href = buildTagUrl(addTag(activeTags, norm(t)));
                return `<li><a class="tag-pill" href="${href}">#${t}</a></li>`;
              }).join('') +
            `</ul>`
          : '';

        // facet pills (camera/lens/film) -> clicking adds `camera:...` tokens
        const facetPills = (camera || lens || film)
          ? `<ul class="tags">` + [
              camera ? `<li><a class="tag-pill" href="${buildTagUrl(addTag(activeTags, norm('camera:'+camera)))}">ğŸ“· ${camera}</a></li>` : '',
              lens   ? `<li><a class="tag-pill" href="${buildTagUrl(addTag(activeTags, norm('lens:'+lens)))}">ğŸ”­ ${lens}</a></li>` : '',
              film   ? `<li><a class="tag-pill" href="${buildTagUrl(addTag(activeTags, norm('film:'+film)))}">ğŸï¸ ${film}</a></li>` : ''
            ].join('') + `</ul>`
          : '';

        // non-click â€œmuseumâ€ list (keep if you still want the stacked meta text)
        const museumMeta = (place)
          ? `<ul class="meta meta--stack"><li class="meta-item">ğŸ“ ${place}</li></ul>`
          : '';

        return `
          <a class="card" href="/img/${base}-2560.jpg" data-index="${idx}" aria-label="Open full-size image of ${alt}">
            <div class="square">
              <img
                src="/img/${base}-640.jpg"
                srcset="/img/${base}-640.jpg 640w,
                        /img/${base}-1280.jpg 1280w,
                        /img/${base}-2560.jpg 2560w"
                sizes="(max-width: 900px) 90vw, 480px"
                alt="${alt}" loading="lazy" />
              ${p.overlay ? `<div class="tile-overlay">${p.overlay}</div>` : ''}
            </div>

            <span class="museum-label">
              <span class="caption">
                <span class="caption-title">${title}</span>
                ${shot ? `<time class="date-badge" datetime="${shot}">${shot}</time>` :
                         (commit ? `<time class="date-badge" datetime="${commit}">${commit}</time>` : '')}
              </span>

              <span class="museum-rule" aria-hidden="true"></span>

              ${facetPills}
              ${museumMeta}
              ${tagPills}
            </span>
          </a>
        `;
      }).join('');

      el.innerHTML = html || '<p class="center">No photos yet.</p>';
    } catch (e) {
      console.error('Failed to load photos.json', e);
      el.innerHTML = '<p class="center">Loading photosâ€¦</p>';
    }
  }

  renderGallery();

  // Lightbox (unchanged)
  document.addEventListener('click', e => {
    const a = e.target.closest('a.card');
    if (!a) return;
    e.preventDefault();
    currentIndex = parseInt(a.dataset.index, 10);
    openLightbox(currentIndex);
  });

  function openLightbox(index) {
    const photo = galleryPhotos[index];
    if (!photo) return;

    const overlay = document.createElement('div');
    overlay.className = 'lightbox-overlay';
    overlay.setAttribute('role','dialog');
    overlay.setAttribute('aria-modal','true');
    overlay.tabIndex = -1;
    overlay.style = `
      position:fixed;inset:0;background:rgba(0,0,0,.92);
      display:flex;align-items:center;justify-content:center;z-index:9999;
    `;

    const closeBtn = document.createElement('div');
    closeBtn.className = 'lb-close';
    closeBtn.textContent = 'Ã—';

    const img = new Image();
    img.src = `/img/${photo.base}-2560.jpg`;
    img.alt = '';
    img.style = 'max-width:95vw;max-height:95vh;';

    const prevBtn = document.createElement('button');
    prevBtn.className = 'lb-arrow lb-prev';
    prevBtn.setAttribute('aria-label', 'Previous photo');
    prevBtn.innerHTML = '&#10094;';

    const nextBtn = document.createElement('button');
    nextBtn.className = 'lb-arrow lb-next';
    nextBtn.setAttribute('aria-label', 'Next photo');
    nextBtn.innerHTML = '&#10095;';

    overlay.appendChild(closeBtn);
    overlay.appendChild(prevBtn);
    overlay.appendChild(nextBtn);
    overlay.appendChild(img);
    document.body.appendChild(overlay);
    document.body.style.overflow = 'hidden';

    const close = () => {
      overlay.remove();
      document.removeEventListener('keydown', keyHandler);
      document.body.style.overflow = '';
    };
    const step = delta => {
      currentIndex = (currentIndex + delta + galleryPhotos.length) % galleryPhotos.length;
      const p = galleryPhotos[currentIndex];
      img.src = `/img/${p.base}-2560.jpg`;
    };
    const keyHandler = ev => {
      if (ev.key === 'Escape') close();
      if (ev.key === 'ArrowRight') step(1);
      if (ev.key === 'ArrowLeft') step(-1);
    };

    closeBtn.addEventListener('click', close);
    overlay.addEventListener('click', ev => { if (ev.target === overlay) close(); });
    prevBtn.addEventListener('click', () => step(-1));
    nextBtn.addEventListener('click', () => step(1));
    document.addEventListener('keydown', keyHandler);
    overlay.focus();
  }
</script>

</body>
</html>
